<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">

<link rel="stylesheet" href="custom.css">

<!-- 1. Title Slide -->
<section style="text-align:center;padding-top:5em;">
  <p id="title">
    <b>
      <!-- <a href="https://github.com/broadinstitute/celldega">Celldega</a> -->
       Celldega: Spatial Analysis and Visualization Library
    </b>
  </p>

  <!-- Spatial Analysis and Visualization Library -->
  <div class="grey" id="sub-title" style="font-size: 75%; margin-top: 5em;">
    <div>Broad Retreat 2024</div>
    <div>Data Visualization Breakout Session</div>
    <div>Spatial Technology Platform</div>
    <br>
    <div>Nicolas Fernandez </div>
    <div>@cornhundred.bsky.social</div>
</div>

</section>

<!-- 2. Biological Motivation -->
<section class='main_section'>

  <p style="text-align:center;padding-top:0.25em;">
    Motivation
  </p>

  <div class="container-normal-slide">

    <div class="text-box-left">
      <p>
        The cell is the fundamental unit of life
      </p>
      <dp>
        Cells differentiate and work together to form intricately organized:
      </p>
      <ul>
        <li>tissues</li>
        <li>organs</li>
        <li>organisms</li>
      </ul>
      <p class="gradient-text">
        Enabled by the careful regulation of transcriptional programs
      </p>
    </div>

    <div class="image-right">
      <div id="visualization"></div>
  </div>

</section>

<!-- 3. Data Visualization -->
<section class='main_section'>

  <p style="text-align:center;padding-top:0.25em;">
    Spatial Transcriptomics
  </p>

  <div class="container-normal-slide">

    <div class="narrow-text-box-left">
      <p>
        Single-cell transcriptomics reveals the <span class="gradient-text">high-dimensional gene expression space</span> that cells reside in
      </p>
      <dp>
        Spatial techniques reveal where cells are located in <span class="gradient-text">physical space</span>
      </p>

    </div>

    <div class="image-right">
      <!-- I want my images here one on top of the other -->

      <img src="frink_high-dimensional-data.jpg" alt="First Image Description" style="width: 60%; margin-left: 3em">
      <img src="frink_spaital-data.jpg" alt="Second Image Description" style="width: 60%; margin-left: 3em">
    </div>

    <!-- Credit Section -->
    <!-- <div class="credit-section">
      <p>Image adapted from Simpsons and Frinkiac</p>
    </div> -->
  </div>

</section>

<!-- 4. Mouse Brain -->
<section >

  <p style="text-align:center;padding-top:0.25em;">Celldega: Xenium Prime Mouse Brain Coronal FF </p>

  <div class='celldega-container' id='celldega-mouse-brain' style="border: 1px solid #d3d3d3;"></div>

</section>

<!-- 5. Human Skin Cancer -->
<section >

  <p style="text-align:center;padding-top:0.25em;">Celldega: Xenium Prime Human Skin Cancer </p>

  <!-- <div class='celldega-container' id='celldega-skin' style="border: 1px solid #d3d3d3;"></div> -->

  <div class="container-landscape-matrix">
    <!-- Landscape visualization -->
    <div class="landscape-left" id="celldega-skin"></div>

    <!-- Matrix visualization -->
    <div class="matrix-right" id="matrix-skin"></div>
  </div>

</section>



<!-- 6. Acknowledgements-->
<section class='main_section'>

  <p style="text-align:center;padding-top:0.25em;">
    Acknowledgements
  </p>

  <div class="container-normal-slide">

    <div class="text-box-left" style="margin-left: 2em">
      <div>Sami Farhi</div>
      <div>Lindsey Erion-Barner</div>
      <div>Michal Lipinski</div>
      <div class="gradient-text" style="font-weight: normal">Huan Wang</div>
      <div><div class="gradient-text" style="font-weight: normal">Jaspreet Ishar</div></div>
      <div>Keisha Matthew</div>
      <div>Sara Sime</div>
      <div>Sachi Krishna</div>
      <div>Jack Nelson</div>
      <div>Brad Tremblay</div>

    </div>

    <div class="image-right">
      <div>Tamara Aleksanyan</div>
      <div>Gunjan Jetley</div>
      <div>Ari Koplowitz</div>
      <div>Lo√Øc Binan</div>
      <div>Vy Ngo</div>
      <div>Jax Xu</div>
      <div>Alec Barrios</div>
      <div>Peter Bryan</div>
      <div>Sartaj Habib</div>
      <div>Byunguk Kang</div>
      <div>Darian Ventura</div>
    </div>
  </div>

  <!-- 7. Links -->
<section class='main_section'>

  <p style="text-align:center;padding-top:0.25em;">
    Links
  </p>

  <div class="container-normal-slide">

    <div class="text-box-left" style="margin-left: 2em">
      <div class="gradient-text">Spatial Technology Platform </div>
      <div style="font-size: 0.75em">broadinstitute.org/spatial-technology-platform</div>
      <div style="font-size: 0.75em"> @stp-broad.bsky.social</div>

    </div>

    <div class="image-right">
      <div class="gradient-text">Celldega</div>
      <div style="font-size: 0.75em">github.com/broadinstitute/celldega</div>
      <div style="font-size: 0.75em">broadinstitute.github.io/Celldega-Broad-Retreat-2024</div>

    </div>
  </div>

  <!-- <div class="container-normal-slide"></div>

    <div class="text-box-left">
      <div>Sami Farhi</div>
      <div>Lindsey Erion-Barner</div>
      <div>Michal Lipinski</div>
      <div>Huan Wang</div>
      <div>Jaspreet Ishar</div>
      <div>Keisha Matthew</div>
      <div>Sara Sime</div>
      <div>Sachi Krishna</div>
      <div>Jack Nelson</div>
      <div>Brad Tremblay</div>
      <div>Tamara Aleksanyan</div>
      <div>Gunjan Jetley</div>
      <div>Ari Koplowitz</div>
    </div>

  </div> -->

</section>

<!-- Slide 4 -->
<!-- <section>

  <p style="text-align:center;padding-top:0.25em;">Celldega: Xenium Pancreas </p>

  <div class="wrap">
    <div class="fleft" >

      <p class="text-box">
        Something about the pancreas.
      </p>

      <p class="text-box">
        Something about the pancreas.
      </p>

    </div>

    <div class='fright' id='celldega-pancreas' style="border: 1px solid #d3d3d3;"></div>
  </div>

</section> -->



<script src="d3.v3.min.js"></script>
<script src="stack.v1.min.js"></script>

<script type="module">

import celldega from 'https://unpkg.com/celldega@0.4.5/src/celldega/static/widget.js?module';

  // Biological Motivation Code
  const width = 600;
  const height = 600;

  const svg = d3.select("#visualization")
    .append("svg")
    .attr("width", width)
    .attr("height", height);

  // Color palette for different cell types
  const colors = ["steelblue", "tomato", "orange", "purple", "green", "cyan"];

  // Function to randomly pick a color
  function randomColor() {
    return colors[Math.floor(Math.random() * colors.length)];
  }

  const scale_up = 2.2
  const x_offset = 150

  // 1. Cell: Single Dot (Start Point)
  svg.append("circle")
    .attr("cx", 100 * scale_up - x_offset)
    .attr("cy", 100 * scale_up)
    .attr("r", 5 * scale_up)
    .attr("fill", randomColor());

  svg.append("text")
    .attr("x", 100 * scale_up - x_offset)
    .attr("y", 50)
    .attr("text-anchor", "middle")
    .style("font-size", "30px")
    .style('font-family', "PT Serif")
    .text("Cell");

  // 2. Organ: Heart Shape Made of Mixed Color Dots
  const heartDots = [
    [150, 90], [160, 80], [170, 80], [180, 90], [190, 80],
    [200, 80], [210, 90], [210, 100], [200, 110], [190, 120],
    [180, 130], [170, 120], [160, 110], [150, 100]
  ];



  heartDots.forEach(d => {
    svg.append("circle")
      .attr("cx", d[0] * scale_up - x_offset)
      .attr("cy", d[1] * scale_up)
      .attr("r", 5 * scale_up)
      .attr("fill", randomColor());
  });

  svg.append("text")
    .attr("x", 180 * scale_up - x_offset)
    .attr("y", 50)
    .attr("text-anchor", "middle")
    .style("font-size", "30px")
    .style('font-family', "PT Serif")
    .text("Organ");

  const stickFigureDots = [
    // Head outline (circular, larger spacing)
    [300, 70], [292, 72], [308, 72], [290, 77], [310, 77],
    [288, 82], [312, 82], [292, 87], [308, 87],

    // Neck and body
    [300, 95], [300, 115], [300, 135], [300, 155],

    // Arms with joints (spaced out further horizontally)
    [280, 115], [320, 115], // Shoulders
    [265, 130], [335, 130], // Elbows
    [250, 145], [350, 145], // Hands

    // Legs with joints (spaced out further vertically)
    [285, 155], [315, 155], // Hips
    [275, 180], [325, 180], // Knees
    [265, 205], [335, 205]  // Feet
  ];

  stickFigureDots.forEach(d => {
    svg.append("circle")
      .attr("cx", d[0] * scale_up - x_offset)
      .attr("cy", d[1]* scale_up)
      .attr("r", 5 * scale_up)
      .attr("fill", randomColor());
  });

  svg.append("text")
    .attr("x", 300 * scale_up - x_offset)
    .attr("y", 50)
    .attr("text-anchor", "middle")
    .style("font-size", "30px")
    .style('font-family', "PT Serif")
    .text("Organism");

var mystack = stack()
  .on("activate", activate)
  .on("deactivate", deactivate);

var section = d3.selectAll("section"),
  follow = d3.select("#follow"),
  followIndex = section[0].indexOf(follow.node());

function refollow() {
  followAnchor.style("top", (followIndex + (1 - mystack.scrollRatio()) / 2 - d3.event.offset) * 100 + "%");
}

function activate(d, i) {
  if (i === followIndex) mystack.on("scroll.follow", refollow);
}

function deactivate(d, i) {
  if (i === followIndex) mystack.on("scroll.follow", null);
}


// celldega mouse brain
//////////////////////////////////
const ini_z = 0
const token = ''

const base_url_mouse_brain = 'https://raw.githubusercontent.com/broadinstitute/celldega_Xenium_Prime_Mouse_Brain_Coronal_FF_outs/main/Xenium_Prime_Mouse_Brain_Coronal_FF_outs'
let ini_x = 20000
let ini_y = 15000
let ini_zoom = -5.5

celldega.landscape_ist(
  d3.select("#celldega-mouse-brain").node(),
  {},
  token,
  ini_x,
  ini_y,
  ini_z,
  ini_zoom,
  base_url_mouse_brain,
  '',
  0.25,
  '100%',
  '100%'
)

// // celldega pancreas
// //////////////////////////////////
// const base_url_pancreas = 'https://raw.githubusercontent.com/broadinstitute/celldega_Xenium_human_Pancreas_FFPE/main/Landscape_Xenium_V1_human_Pancreas_FFPE_outs_webp'

// ini_x = 20000
// ini_y = 15000
// ini_zoom = -5.5

// celldega.landscape_ist(
//   d3.select("#celldega-pancreas").node(),
//   {},
//   token,
//   ini_x,
//   ini_y,
//   ini_z,
//   ini_zoom,
//   base_url_pancreas,
//   '',
//   0.25,
//   '100%',
//   '100%'
// )

// celldega skin cancer
//////////////////////////////

const base_url_skin = 'https://raw.githubusercontent.com/broadinstitute/celldega_Xenium_Prime_Human_Skin_FFPE_outs/main/Xenium_Prime_Human_Skin_FFPE_outs'

ini_x = 20000
ini_y = 20000
ini_zoom = -6.0

const landscape_skin = await celldega.landscape_ist(
  d3.select("#celldega-skin").node(),
  {},
  token,
  ini_x,
  ini_y,
  ini_z,
  ini_zoom,
  base_url_skin,
  '',
  0.25,
  '100%',
  '100%'
)

const net_url = 'https://raw.githubusercontent.com/broadinstitute/celldega_Xenium_Prime_Human_Skin_FFPE_outs/main/Xenium_Prime_Human_Skin_FFPE_outs/tmp.json'

const network = await fetch(net_url)
  .then(response => response.json())
  .then(data => {
      console.log(data);
      return data;
  });

let matrix_container = document.querySelector("#matrix-skin");
console.log(matrix_container)

console.log(landscape_skin)

const size = 500

celldega.matrix_viz(
  {},
  matrix_container,
  network,
  size,
  size,
  landscape_skin.update_matrix_gene,
  landscape_skin.update_matrix_col,
  landscape_skin.update_matrix_dendro_col
);




</script>
